<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Mouse的博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/css/theme.css" rel="stylesheet" type="text/css">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css">
    
    <link rel="icon" href="/images/favicon.ico">
    
</head>

<body>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                  <span class="sr-only">Toggle navigation</span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                  <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Mouse的博客</a>
              </div>
              <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="/">Home</a></li>
                    <li class="active visible-xs-block"><a href="/links.html">Links</a></li>
                    <li class="active"><a href="/archive.html">Archive</a></li>
                    <li class="active"><a href="/about.html">About</a></li>
                    <li class="active"><a href="/feed.xml">RSS</a></li>
                    
                      <li class="active"><a href="https://github.com/gongchangyou/gongchangyou.github.io">Github</a></li>
                    
                </ul>
              </div>
        </div>
    </div>
</div>


<style>
  table{
    border-left:1px solid #000000;border-top:1px solid #000000;
    width: 100%;
    word-wrap:break-word; word-break:break-all;
  }
  table th{
  text-align:center;
  }
  table th,td{
    border-right:1px solid #000000;border-bottom:1px solid #000000;
  }
</style>

<div class="container container-left">
    <div class="row">
        <div class="col-md-3 hidden-xs">
            <div class="sidebar well" align="center">
<img src="/images/favicon.ico" alt=""/>
<h4>
记录学习生活工作的点滴
</h4>
</div>

<div class="sidebar well">
    <h1>Recent Posts</h1>
    <ul>
        
          <li><a href="/2022/08/b+tree">b+tree</a></li>
        
          <li><a href="/2022/08/scope">scope</a></li>
        
          <li><a href="/2022/07/autowired-list">autowired</a></li>
        
          <li><a href="/2022/07/xml">xml</a></li>
        
          <li><a href="/2022/07/poi">poi</a></li>
        
    </ul>
</div>
<div class="sidebar well">
	<h1>标签</h1>
		
			
				<li><a href="/tag/c++" title="c++">c++<sup>13</sup></a></li>
			
		
			
				<li><a href="/tag/git" title="git">git<sup>6</sup></a></li>
			
		
			
				<li><a href="/tag/ios" title="ios">ios<sup>5</sup></a></li>
			
		
			
				<li><a href="/tag/mac" title="mac">mac<sup>1</sup></a></li>
			
		
			
				<li><a href="/tag/life" title="life">life<sup>21</sup></a></li>
			
		
			
				<li><a href="/tag/mysql" title="mysql">mysql<sup>15</sup></a></li>
			
		
			
				<li><a href="/tag/shell" title="shell">shell<sup>11</sup></a></li>
			
		
			
				<li><a href="/tag/python" title="python">python<sup>9</sup></a></li>
			
		
			
				<li><a href="/tag/shader" title="shader">shader<sup>1</sup></a></li>
			
		
			
				<li><a href="/tag/php" title="php">php<sup>5</sup></a></li>
			
		
			
				<li><a href="/tag/java" title="java">java<sup>67</sup></a></li>
			
		
			
				<li><a href="/tag/kotlin" title="kotlin">kotlin<sup>1</sup></a></li>
			
		
			
				<li><a href="/tag/rocketmq" title="rocketmq">rocketmq<sup>5</sup></a></li>
			
		
			
				<li><a href="/tag/go" title="go">go<sup>5</sup></a></li>
			
		
			
				<li><a href="/tag/elasticsearch" title="elasticsearch">elasticsearch<sup>4</sup></a></li>
			
		
			
				<li><a href="/tag/k8s" title="k8s">k8s<sup>1</sup></a></li>
			
		
			
				<li><a href="/tag/webgl" title="webgl">webgl<sup>1</sup></a></li>
			
		
</div>
<!-- 
<div class="sidebar well">
<h1>Links</h1>
<ul>
  <li><a href="#">One</a></li>
  <li><a href="#">Two</a></li>
  <li><a href="#">Three</a></li>
  <li><a href="#">Four</a></li>
</ul>

</div> -->

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
                <h1><a href="/2022/03/es">Mar 14, 2022 - es-install</a></h1>
            
            <div class="post-content">
            <h1 id="docker-install--elasticsearch">Docker install  ElasticSearch</h1>

<h3 id="如果想部署-kibana--es--httpsquoeamastermediumcomdeploying-elasticsearch-and-kibana-with-docker-86a4ac78d851">如果想部署 kibana + es ： <a href="https://quoeamaster.medium.com/deploying-elasticsearch-and-kibana-with-docker-86a4ac78d851">https://quoeamaster.medium.com/deploying-elasticsearch-and-kibana-with-docker-86a4ac78d851</a></h3>

<ol>
  <li>
    <p>docker pull</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> docker pull docker.elastic.co/kibana/kibana:8.1.0
</code></pre></div>    </div>
  </li>
  <li>
    <p>docker-compose.yml</p>
  </li>
</ol>

<p><a href="/images/202203/docker-compose.yml">下载 yaml</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '2.2'
services:
 node01:
   image: docker.elastic.co/elasticsearch/elasticsearch:8.2.0
   container_name: node01
   environment:
     - node.name=node01
     - cluster.name=es-cluster-7
     - discovery.type=single-node
     - xpack.security.enabled=false
     - "ES_JAVA_OPTS=-Xms1G -Xmx1G"
   ulimits:
     memlock:
       soft: -1
       hard: -1
   volumes:
     - es-data01:/usr/share/elasticsearch/data
   ports:
     - 9200:9200
   networks:
     - es-network

 kibana:
   image: docker.elastic.co/kibana/kibana:8.2.0
   environment:
     ELASTICSEARCH_HOSTS: http://node01:9200
   ports:
     - 5601:5601
   networks:
     - es-network
   depends_on:
     - node01

volumes:
 es-data01:
   driver: local

networks:
 es-network:
   driver: bridge
</code></pre></div></div>

<ol>
  <li>
    <blockquote>
      <p>docker-compose up</p>
    </blockquote>
  </li>
  <li>
    <p>浏览器 访问 http://localhost:5601/</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://localhost:5601/app/dev_tools#/console #dev tool 可以直接敲命令
</code></pre></div>    </div>
  </li>
</ol>

<p>查看所有索引</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET _cat/indices
</code></pre></div></div>

<p>注意：最好把版本升级下 7.11.1 -&gt; 7.17.0，因为java的客户端 8.1.0会报错 Missing [X-Elastic-Product] header.</p>

<p>如果要压测的话，上面的jvm内存调大一点，至少10G吧.   如果想要使用kNN查询的话，最好把版本升到8.0以上，比如8.1.0. <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/knn-search-api.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/knn-search-api.html</a></p>

<p>热力图可视化  <a href="https://www.freesion.com/article/72491420060/">https://www.freesion.com/article/72491420060/</a></p>

<p>重点是要在stack management中创建index pattern!! 否则无法在Visualize 页面创建关于这个index的可视化界面</p>

<p>可以点击inspect 看request 语句</p>

<p><img src="/images/202203/WechatIMG49.png" alt="" width="800" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET users/_search 
{
  "aggs": {
    "2": {
      "terms": {
        "field": "country.keyword",
        "order": {
          "_count": "desc"
        },
        "size": 2
      },
      "aggs": {
        "3": {
          "terms": {
            "field": "age",
            "order": {
              "_count": "desc"
            },
            "size": 2
          }
        }
      }
    }
  },
  "size": 0,
  "fields": [],
  "script_fields": {},
  "stored_fields": [
    "*"
  ],
  "_source": {
    "excludes": []
  },
  "query": {
    "bool": {
      "must": [],
      "filter": [
        {
          "match_all": {}
        }
      ],
      "should": [],
      "must_not": []
    }
  }
}
</code></pre></div></div>

<p>坐标系的热力图的 query</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get users/_search
{
  "aggs": {
    "2": {
      "range": {
        "field": "age",
        "ranges": [
          {
            "to": 10,
            "from": 0
          },
          {
            "to": 20,
            "from": 10
          },
          {
            "to": 30,
            "from": 20
          },
          {
            "to": 37,
            "from": 30
          }
        ],
        "keyed": true
      },
      "aggs": {
        "2": {
          "range": {
            "field": "age",
            "ranges": [
              {
                "to": 10,
                "from": 0
              },
              {
                "to": 20,
                "from": 10
              },
              {
                "to": 30,
                "from": 20
              },
              {
                "to": 40,
                "from": 30
              }
            ],
            "keyed": true
          }
        }
      }
    }
  },
  "size": 0,
  "fields": [],
  "script_fields": {},
  "stored_fields": [
    "*"
  ],
  "_source": {
    "excludes": []
  },
  "query": {
    "bool": {
      "must": [],
      "filter": [
        {
          "match_all": {}
        }
      ],
      "should": [],
      "must_not": []
    }
  }
}
</code></pre></div></div>

<p>附： docker-compose 安装 <a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a></p>

<h3 id="单独部署-es">单独部署 ES</h3>

<p>官网 ： <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull docker.io/elasticsearch

docker network create elastic

docker run --name es01 --net elastic -p 9200:9200 -p 9300:9300 -it docker.elastic.co/elasticsearch/elasticsearch:8.1.0

docker cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt .

curl --cacert http_ca.crt -u elastic https://localhost:9200 

输入docker run 时的password即可
</code></pre></div></div>

<p>问题1： 报错</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR: [1] bootstrap checks failed. You must address the points described in the following [1] lines before starting Elasticsearch.
bootstrap check failure [1] of [1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]
ERROR: Elasticsearch did not exit normally - check the logs at /usr/share/elasticsearch/logs/docker-cluster.log
</code></pre></div></div>

<p>虚拟内存太小了。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/sysctl.conf 
vm.max_map_count=655360
</code></pre></div></div>

<p>重启</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --name es01 --net elastic -p 9200:9200 -p 9300:9300 -it docker.elastic.co/elasticsearch/elasticsearch:8.1.0
</code></pre></div></div>

<p>几个常用的命令</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#查看索引结构
GET /table_ik

#grid_cell是索引库的名称
GET /table_ik/_count

#查看所有的索引
GET /_cat/indices/
</code></pre></div></div>


            </div>
            
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
            </div>
          </div>
          <div class="pagination">
              
                <a class="btn btn-default" href="/2022/03/es-heatmap" class="next">Newer Post</a>
              
              
                <a class="btn btn-default" href="/2022/03/go(1)" class="previous">Older Post</a>
              
</div>

        </div>
    </div>
</div>
<!--  -->
<!-- <p id="post-meta">Posted with <i class="fa fa-tag"></i>: <a href="/tag/life/">生活</a></p> -->

  <script type="text/javascript">
    var disqus_shortname = '';

    var disqus_config = function () {
        this.page.identifier = '2022-03-es';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12 footer navbar-inverse navbar-fixed-bottom">
            <p class="copyright">&copy;2022 Mouse的博客. Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme by <a href="https://github.com/scotte/jekyll-clean">Scott Emmons</a>
            under
            <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution</a></p>
        </div>
    </div>
</div>






</body>
</html>

