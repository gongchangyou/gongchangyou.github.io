---
layout: post
title: "es"
date: 2022-03-15 11:05:06 +0800
comments: true
category: mysql
tag: [mysql]
---

#  ElasticSearch 热力图性能测评

代码仓库：[https://github.com/gongchangyou/elasticsearch-test](https://github.com/gongchangyou/elasticsearch-test)





java客户端 [https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/introduction.html](https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/current/introduction.html)

创建索引: [https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-create-index.html#_index_settings](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-create-index.html#_index_settings)



10000个点热力图40ms

1000000 个点 热力图, 不测了。直接上7kw个点



7kw 个点 热力图

 搜索10*10的矩形， 首次查询5-6s，效果还是非常不错的。

 搜索100*100的矩形， 首次查询10-11s. 

搜索1000*1000， 报错 "too_many_buckets_exception" 这是ES为了性能考虑。 我们尝试调大一点 2000000。实测23s左右耗时。

当然实际情况更多的是查看局部，这样就会退化成500*500个bucket，这样查询耗时依然是10s左右，可以接受.

```
PUT /_cluster/settings
{"persistent": {"search.max_buckets": 2000000}}
```



现在唯一的问题就是存储空间，7kw个点的是4g+ ，如果200个数据集将近1T。

![]({{ site.baseurl}}/images/202203/WechatIMG50.png){: width="800" }




问题1： JacksonJsonpMapper NoClassDefFoundError 

```
   <properties>
        <jakarta-json.version>2.0.1</jakarta-json.version> #这里把版本号设置成2.0.1
        <java.version>11</java.version>
    </properties>
```



问题2： Missing [X-Elastic-Product] header. 

解决2： elasticsearch 升级下版本，7.17.0+