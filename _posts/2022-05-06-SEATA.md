---
layout: post
title: "seata"
date: 2022-05-06 10:25:06 +0800
comments: true
category: java
tag: [java]
---

# SEATA 分布式事务

官网： [https://seata.io/zh-cn/docs/overview/what-is-seata.html](https://seata.io/zh-cn/docs/overview/what-is-seata.html)

```
跨服务调用场景下的事务传播，本质上就是要把 XID 通过服务调用传递到服务提供方，并绑定到 RootContext 中去。
```



## AT的实现方案

参考文章 [https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html](https://seata.io/zh-cn/docs/ops/deploy-guide-beginner.html)

[https://seata.io/zh-cn/docs/user/quickstart.html](https://seata.io/zh-cn/docs/user/quickstart.html)



### 前提

>基于支持本地 ACID 事务的关系型数据库。
Java 应用，通过 JDBC 访问数据库。



下面是一个具体的例子：订单扣库存的解决方案

​    ![]({{ site.baseurl}}/images/202205/solution.png){: width="800" }

具体的操作步骤有3步：

​	一. 启动事务协调者进程 TC， 

​	二. 在DB中创建一些表例如undo log 来维护事务xid ，branchid （子事务） 的状态和回滚。

​	三. 在业务服务中添加 seata依赖，动态代理datasource. 这样可以在db操作前后做一些undo log的记录之类的操作。



<font color="red">个人感觉稍微有点麻烦了。而且看前提 适用范围不是很广，我们做分布式事务大概率是跟别的业务线或者第三方公司交互，他们不太可能跟你注册在同一个注册中心，且他们大概率不愿意在自己的代码中添加seata依赖。</font>



### 下面的先不用看了，因为我没搭建完成，官网有些地方说的不是很详细。



我们做个微服务来测试下

一. 先搭建几个dubbo的服务

1. 先把nacos 启动起来 [启动nacos](../../../2022/01/nacos)
2. 启动 maven仓库   [启动maven仓库](../../../2022/01/maven)
3. 注册两个service， 新增一个consumer , 注意 dubbo.application.parameters.group 需要配置成相同的。 代码仓库如下
   1. [https://github.com/gongchangyou/service-order](https://github.com/gongchangyou/service-order)
   2. [https://github.com/gongchangyou/service-store](https://github.com/gongchangyou/service-store)
   3. [https://github.com/gongchangyou/service-buy](https://github.com/gongchangyou/service-buy)

二.  启动TC服务， 唉，不希望侵入式的写代码，就得在外部有个协调者。

1. 直接 docker-compose up  [https://github.com/seata/seata/blob/1.4.0/script/server/docker-compose/docker-compose.yaml](https://github.com/seata/seata/blob/1.4.0/script/server/docker-compose/docker-compose.yaml)

    ```
    version: "3"
    services:
    	seata-server:
    		image: seataio/seata-server
    		hostname: seata-server
        ports:
          - "8091:8091"
        environment:
          - SEATA_PORT=8091
          - STORE_MODE=file
    ```

2. 或者 [https://seata.io/zh-cn/docs/ops/deploy-by-docker.html](https://seata.io/zh-cn/docs/ops/deploy-by-docker.html). 注意 SEATA_IP 改成本地ip

   参考文章: [https://seata.io/zh-cn/blog/seata-nacos-docker.html](https://seata.io/zh-cn/blog/seata-nacos-docker.html) TODO 文档中的 nacos-config.txt 我不知道在哪里。或许script文件夹已经删掉了, 现在需要手动创建  nacos-config.txt 和nacos-config.sh  手动把seata服务注册到nacos中。

   ```
   $ docker run --name seata-server \
           -dit \
           --restart=always \
           -p 8091:8091 \
           -p 7091:7091 \
           -e SEATA_IP=192.168.1.2 \
           -e SEATA_PORT=8091 \
           seataio/seata-server
   ```

三. 业务系统集成

1. 添加依赖 任选一个, 我选择 spring-cloud-alibaba-seata
> 依赖seata-all
依赖seata-spring-boot-starter，支持yml、properties配置(.conf可删除)，内部已依赖seata-all
依赖spring-cloud-alibaba-seata，内部集成了seata，并实现了xid传递

3. 创建 undo log表

   ```
   -- 注意此处0.3.0+ 增加唯一索引 ux_undo_log
   CREATE TABLE `undo_log` (
     `id` bigint(20) NOT NULL AUTO_INCREMENT,
     `branch_id` bigint(20) NOT NULL,
     `xid` varchar(100) NOT NULL,
     `context` varchar(128) NOT NULL,
     `rollback_info` longblob NOT NULL,
     `log_status` int(11) NOT NULL,
     `log_created` datetime NOT NULL,
     `log_modified` datetime NOT NULL,
     `ext` varchar(100) DEFAULT NULL,
     PRIMARY KEY (`id`),
     UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
   ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
   ```

   





问题1 ：2022-05-26 22:51:29.575  WARN [configOperate_2_2] io.seata.config.FileConfiguration : Could not found property service.disableGlobalTransaction, try to use default value instead.

解决1: [https://blog.csdn.net/m0_43404934/article/details/110134708](https://blog.csdn.net/m0_43404934/article/details/110134708) 创建file.conf文件 里面写

```
service {
disableGlobalTransaction = false
}
```



问题2：  io.seata.core.rpc.netty.NettyClientChannelManager : no available service 'default' found, please make sure registry config correct

解决2：